# This .travis.yml file was autogenerated from github.com/ericdill/travis-little-helper/template.py.
# Please do not edit this by hand!

language: python

sudo: false

services:
  - mongodb
matrix:
  include:
  - python: 2.7
  - python: 3.4
  - python: 3.5

before_install:
  - env
  # `git describe` failed a couple of times if I don't `git fetch --unshallow`
  - git fetch --unshallow
  # GRAB THE HELPER SCRIPTS
  - git clone https://github.com/ericdill/travis-little-helper ../travis-little-helper
  # ECHO THE ENVIRONMENTAL VARIABLES THAT WERE SET

  # INSTALL CONDA
  - wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
  - chmod +x miniconda.sh
  - "./miniconda.sh -b -p /home/travis/mc"
  - export PATH=/home/travis/mc/bin:$PATH
  - conda config --set always_yes true
  - conda update conda --yes
  - conda config --add channels lightsource2
  - conda config --add channels lightsource2-dev
  - conda config --add channels tacaswell

  # CONFIGURE USEFUL ENVIRONMENTAL VARIABLES
  - export OWNER_NAME=$(IFS="/"; arr=($TRAVIS_REPO_SLUG); echo ${arr[0]})
  - export REPO_NAME=$(IFS="/"; arr=($TRAVIS_REPO_SLUG); echo ${arr[1]})
  - export CONDA_BUILD_COMMAND="conda build conda-recipe --python=$TRAVIS_PYTHON_VERSION"
  - export GIT_FULL_HASH=`git rev-parse HEAD`
  # SOME DEBUG OUTPUT
  - echo "OWNER_NAME=$OWNER_NAME"
  - echo "REPO_NAME=$REPO_NAME"
  - echo "TRAVIS_COMMIT=$TRAVIS_COMMIT"
  - git describe
  # INSTALL DEPS FOR BUILDING AND UPLOADING
  - conda install conda-build jinja2 anaconda-client
  - conda create -n testenv python=$TRAVIS_PYTHON_VERSION
  - source activate testenv
  - conda install -c ericdill depfinder
  # MAKE THE CONDA RECIPE
  - wget https://raw.githubusercontent.com/ericdill/conda-skeletor-configs/master/ophyd/conda-skeletor.yml
  - pip install https://github.com/ericdill/conda-skeletor/zipball/master#egg=conda_skeletor
  - conda skeletor -p . -o conda-recipe

install:
  - conda install `python ../travis-little-helper/list_test_deps.py -p conda-recipe/meta.yaml`
  - python setup.py install
  # SOME DEBUG OUTPUT
  - python -c "import $REPO_NAME; print($REPO_NAME.__version__)"

# script:
#   - python run_tests.py -v
#   - "$CONDA_BUILD_COMMAND"
